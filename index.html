<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Our Journey | Memory Studio v7.6</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@200;300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary-bao: #0ea5e9; --primary-na: #f472b6; --bg-dark: #020617; }
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-dark); color: #f8fafc; overflow: hidden; height: 100vh; margin: 0; }
    #threejs-canvas { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0; pointer-events: none; }
    
    .reveal-text { opacity: 0; transform: translateY(20px); filter: blur(10px); transition: all 1s cubic-bezier(0.22, 1, 0.36, 1); }
    .reveal-active { opacity: 1 !important; transform: translateY(0) !important; filter: blur(0) !important; }
    
    .heartbeat-slow { animation: pulseSlow 4s ease-in-out infinite; }
    @keyframes pulseSlow { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.04); } }
    
    .page { display: none; width: 100%; min-height: 100%; position: relative; z-index: 10; }
    .page.active { display: flex; flex-direction: column; }
    
    .bento-card { background: rgba(15, 23, 42, 0.4); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(25px); }
    .nav-link.active { border-left: 5px solid white; background: rgba(255,255,255,0.08); opacity: 1 !important; }

    #sidebar { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 100; }
    @media (max-width: 768px) {
      #sidebar { position: fixed; top: 0; left: 0; transform: translateX(-100%); height: 100vh; width: 280px; box-shadow: 20px 0 50px rgba(0,0,0,0.5); }
      #sidebar.open { transform: translateX(0); }
      #sidebar-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 90; }
      #sidebar.open + #sidebar-overlay { display: block; }
      #floating-player { left: 1rem !important; right: 1rem !important; width: auto !important; bottom: 1rem !important; }
    }

    .timeline-container { position: relative; width: 100%; margin-top: 2rem; }
    .timeline-line { position: absolute; left: 50%; transform: translateX(-50%); width: 2px; height: 100%; background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.1) 10%, rgba(255,255,255,0.1) 90%, transparent); }
    .timeline-dot { position: absolute; left: 50%; transform: translate(-50%, 40px); width: 14px; height: 14px; border-radius: 50%; z-index: 20; }
    
    @media (max-width: 768px) { 
      .timeline-line { left: 20px !important; transform: none !important; } 
      .timeline-dot { left: 20px !important; transform: translateY(40px) !important; } 
      .memory-row { flex-direction: column !important; padding-left: 45px !important; align-items: flex-start !important; }
      .memory-card-wrapper { width: 100% !important; padding: 0 !important; }
    }

    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .disk-rotate { animation: rotate 12s linear infinite; }
    .music-paused { animation-play-state: paused; }
    
    @keyframes glow { 0%, 100% { box-shadow: 0 0 20px rgba(14, 165, 233, 0.2); } 50% { box-shadow: 0 0 40px rgba(14, 165, 233, 0.5); } }
    .playing-glow { animation: glow 3s infinite ease-in-out; border-color: rgba(14, 165, 233, 0.8) !important; }

    #floating-player {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 350px;
        z-index: 200;
        transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        transform: scale(0.9) translateY(20px);
        opacity: 0;
    }
    #floating-player.show { transform: scale(1) translateY(0); opacity: 1; }

    .wave-bar { width: 3px; height: 8px; background: #0ea5e9; border-radius: 2px; }
    .wave-active { animation: wave-anim 0.6s infinite alternate; }
    @keyframes wave-anim { from { height: 4px; } to { height: 14px; } }
  </style>
</head>
<body class="flex flex-col md:flex-row">
  <canvas id="threejs-canvas"></canvas>

  <div id="login-overlay" class="fixed inset-0 bg-slate-950 z-[200] flex items-center justify-center p-6 text-center">
    <div class="max-w-md w-full">
      <h2 class="text-4xl font-black mb-12 italic text-white tracking-tighter">X√°c nh·∫≠n danh t√≠nh</h2>
      <div id="profile-select" class="grid grid-cols-2 gap-6">
        <button onclick="selectUser('bao')" class="p-8 bento-card rounded-[2.5rem] hover:border-sky-500 transition-all">
          <img src="./images/haruto.png" class="w-24 h-24 mx-auto mb-4 rounded-full border-4 border-sky-500 object-cover">
          <span class="font-bold text-sky-400 uppercase text-sm">B·∫£o</span>
        </button>
        <button onclick="selectUser('ngocanh')" class="p-8 bento-card rounded-[2.5rem] hover:border-pink-500 transition-all">
          <img src="./images/NgocAnh.png" class="w-24 h-24 mx-auto mb-4 rounded-full border-4 border-pink-500 object-cover">
          <span class="font-bold text-pink-400 uppercase text-sm">Ng·ªçc Anh</span>
        </button>
      </div>
      <div id="password-box" class="hidden mt-8">
        <div class="relative mb-4">
          <input type="password" id="login-password" placeholder="M·∫≠t kh·∫©u..." class="w-full bg-white/5 border border-white/10 rounded-2xl p-5 text-center text-xl outline-none text-white">
          <button onclick="togglePassword('login-password')" class="absolute right-5 top-1/2 -translate-y-1/2 opacity-30 hover:opacity-100">üëÅÔ∏è</button>
        </div>
        <button id="btn-login-verify" class="w-full bg-white text-black py-5 rounded-2xl font-bold uppercase tracking-widest text-sm">V√†o Studio</button>
      </div>
    </div>
  </div>

  <div class="md:hidden flex items-center justify-between p-5 bg-black/50 backdrop-blur-md border-b border-white/5 z-50">
    <span class="font-black italic text-lg text-sky-400">STUDIO</span>
    <button onclick="toggleSidebar()"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-9 h-9 text-white"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg></button>
  </div>

  <aside id="sidebar" class="bg-[#020617] md:bg-black/20 md:backdrop-blur-xl border-r border-white/5 p-6 flex flex-col gap-8 w-full md:w-[300px]">
    <div class="flex justify-center items-center gap-5 px-2">
      <div id="user-avatar" class="w-[100px] h-14 rounded-[1.2rem] overflow-hidden border-2 border-white/10 shadow-2xl"></div>
      <h1 id="user-greeting" class="font-extrabold text-xl italic text-white truncate w-full">Ch√†o!</h1>
    </div>
    <nav class="flex flex-col gap-4 mt-10">
      <button onclick="switchPage('home', this)" class="nav-link active p-5 rounded-2xl text-md font-bold text-left text-white">üè† Trang ch·ªß</button>
      <button onclick="switchPage('timeline', this)" class="nav-link p-5 rounded-2xl text-md font-bold opacity-50 text-left text-white">üìÖ Timeline</button>
      <button onclick="switchPage('music-lab', this)" class="nav-link p-5 rounded-2xl text-md font-bold opacity-50 text-left text-white">üéµ Music Lab</button>
      <button onclick="document.getElementById('change-pw-modal').classList.remove('hidden')" class="nav-link p-5 rounded-2xl text-md font-bold opacity-50 text-left text-white">üîë M·∫≠t kh·∫©u</button>
      <button onclick="sessionStorage.clear(); window.location.reload();" class="mt-auto p-5 text-xs font-bold opacity-30 text-white uppercase text-left">ƒêƒÉng xu·∫•t</button>
    </nav>
  </aside>
  <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

  <div id="floating-player" class="bento-card p-4 rounded-[2rem] border border-white/10 shadow-2xl">
      <div class="flex items-center gap-4">
          <div id="music-disk" class="w-16 h-16 rounded-full border-2 border-white/20 shadow-lg overflow-hidden disk-rotate music-paused flex-shrink-0 transition-all duration-700">
              <img src="https://cdn-icons-png.flaticon.com/512/6048/6048452.png" class="w-full h-full object-cover">
          </div>
          <div class="flex-1 overflow-hidden text-left">
              <div class="flex items-center gap-2 mb-1">
                 <p id="current-song-title" class="text-[11px] font-black text-white truncate uppercase tracking-[0.1em]">ƒêang t·∫£i nh·∫°c...</p>
                 <div id="mini-wave" class="flex gap-1 items-end h-3 hidden">
                    <div class="wave-bar wave-active" style="animation-delay: 0.1s"></div>
                    <div class="wave-bar wave-active" style="animation-delay: 0.3s"></div>
                    <div class="wave-bar wave-active" style="animation-delay: 0.5s"></div>
                 </div>
              </div>
              <p id="current-song-author" class="text-[9px] text-slate-500 uppercase">G·ª≠i b·ªüi: ---</p>
              <div class="flex items-center gap-5 mt-3">
                  <button onclick="prevSong()" class="text-white opacity-40 hover:opacity-100 transition-opacity hover:scale-110 active:scale-90"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                  <button onclick="toggleMusic()" id="play-btn" class="w-9 h-9 bg-white text-black rounded-full flex items-center justify-center hover:scale-110 active:scale-90 transition-transform shadow-[0_0_15px_rgba(255,255,255,0.3)]">‚ñ∂</button>
                  <button onclick="nextSong()" class="text-white opacity-40 hover:opacity-100 transition-opacity hover:scale-110 active:scale-90"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M16 18h2V6h-2zM6 18l8.5-6L6 6z"/></svg></button>
              </div>
          </div>
      </div>
  </div>

  <main class="flex-1 overflow-y-auto h-full relative">
    <section id="home" class="page active px-6 justify-center items-center">
        <div class="absolute w-[300px] md:w-[600px] h-[300px] md:h-[600px] bg-sky-500/10 blur-[150px] rounded-full"></div>
        <div class="reveal-text flex -space-x-8 md:-space-x-16 mb-10 heartbeat-slow">
            <img src="./images/haruto.png" class="w-24 h-24 md:w-52 md:h-52 rounded-full border-[4px] md:border-[6px] border-sky-500 object-cover z-20 shadow-2xl">
            <img src="./images/NgocAnh.png" class="w-24 h-24 md:w-52 md:h-52 rounded-full border-[4px] md:border-[6px] border-pink-500 object-cover z-10 shadow-2xl">
        </div>
        <div class="reveal-text flex gap-4 md:gap-14 items-center mb-8 bg-white/5 px-6 md:px-10 py-5 rounded-[2rem] md:rounded-[2.5rem] border border-white/10 backdrop-blur-md">
            <div class="flex flex-col items-center"><span id="hrs" class="text-2xl md:text-5xl font-light">00</span><span class="text-[8px] md:text-[11px] font-black uppercase tracking-widest text-slate-500">GI·ªú</span></div>
            <div class="flex flex-col items-center"><span id="mins" class="text-2xl md:text-5xl font-light">00</span><span class="text-[8px] md:text-[11px] font-black uppercase tracking-widest text-slate-500">PH√öT</span></div>
            <div class="flex flex-col items-center"><span id="secs" class="text-2xl md:text-5xl font-light text-sky-400">00</span><span class="text-[8px] md:text-[11px] font-black uppercase tracking-widest text-slate-500">GI√ÇY</span></div>
        </div>
        <div class="reveal-text text-center">
          <p class="text-sky-400 font-bold tracking-[0.3em] md:tracking-[0.5em] uppercase text-[9px] md:text-[11px] mb-4">Our Eternal Chapter Since Dec, 25, 2025</p>
          <div class="relative inline-block">
            <h2 class="text-[100px] md:text-[250px] font-thin text-white leading-none tracking-tighter" id="days-main">0</h2>
            <span class="absolute -right-10 md:-right-20 bottom-6 md:bottom-16 text-sky-500 text-xl md:text-5xl font-black italic tracking-tighter">DAYS</span>
          </div>
        </div>
    </section>

    <section id="timeline" class="page p-6 md:p-20 hidden">
        <div class="max-w-6xl mx-auto pb-32 text-left">
            <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-8">
                <h2 class="text-5xl md:text-8xl font-black italic tracking-tighter text-white">Timeline</h2>
                <button onclick="document.getElementById('timeline-modal').classList.remove('hidden')" class="bg-white text-black px-8 md:px-10 py-4 md:py-5 rounded-[1.5rem] md:rounded-[2rem] font-black text-xs md:text-sm tracking-widest shadow-2xl hover:scale-105 transition-transform">VI·∫æT K·ªà NI·ªÜM</button>
            </div>
            <div class="flex flex-col md:flex-row gap-4 mb-16 items-start md:items-center">
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-[10px] font-black text-sky-400 uppercase tracking-widest">L·ªçc:</span>
                    <input type="date" id="filter-date" onchange="loadMemories(this.value)" class="bg-white/5 border border-white/10 rounded-xl py-3 pl-14 pr-4 outline-none text-white text-sm focus:border-sky-500 transition-all">
                </div>
                <button onclick="document.getElementById('filter-date').value=''; loadMemories();" class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500 hover:text-white transition-colors">Hi·ªán t·∫•t c·∫£</button>
            </div>
            <div class="timeline-container">
                <div class="timeline-line"></div>
                <div id="timeline-content" class="space-y-12"></div>
            </div>
        </div>
    </section>

    <section id="music-lab" class="page p-6 md:p-20 hidden">
        <div class="max-w-4xl mx-auto text-left">
            <h2 class="text-5xl md:text-8xl font-black italic text-white mb-10">Music Lab</h2>
            <div class="bento-card p-8 rounded-[2.5rem] mb-10 border-t-4 border-sky-500">
                <h3 class="text-xl font-bold text-white mb-6 uppercase tracking-widest text-xs">Th√™m b√†i h√°t m·ªõi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="song-name" placeholder="T√™n b√†i h√°t..." class="bg-white/5 border border-white/10 rounded-2xl p-4 text-white outline-none">
                    <input type="text" id="song-url" placeholder="Link nh·∫°c (.mp3)..." class="bg-white/5 border border-white/10 rounded-2xl p-4 text-white outline-none">
                </div>
                <button onclick="uploadSong()" class="w-full py-4 bg-white text-black font-black rounded-2xl uppercase tracking-widest text-xs">C·∫≠p nh·∫≠t Album</button>
            </div>
            <div id="song-list" class="space-y-4 pb-20"></div>
        </div>
    </section>
  </main>

  <div id="change-pw-modal" class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[300] hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-white/10 w-full max-w-sm rounded-[2.5rem] p-10">
      <h3 class="text-2xl font-black mb-8 italic text-white text-center">ƒê·ªïi m·∫≠t kh·∫©u</h3>
      <input type="password" id="new-pw" placeholder="M·∫≠t kh·∫©u m·ªõi..." class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none text-white mb-4">
      <button onclick="updatePassword()" class="w-full py-4 rounded-2xl font-bold text-white bg-sky-500">C·∫≠p nh·∫≠t</button>
      <button onclick="document.getElementById('change-pw-modal').classList.add('hidden')" class="w-full mt-4 text-white opacity-50">H·ªßy</button>
    </div>
  </div>

  <div id="timeline-modal" class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[300] hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 border border-white/10 w-full max-w-lg rounded-[2.5rem] p-8 md:p-10 shadow-2xl">
      <h3 class="text-3xl font-black mb-8 italic text-white">Ghi l·∫°i kho·∫£nh kh·∫Øc</h3>
      <div class="space-y-4">
        <input type="text" id="m-title" placeholder="Ti√™u ƒë·ªÅ k·ª∑ ni·ªám..." class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none text-white text-left">
        <textarea id="m-desc" placeholder="Ch√∫ng m√¨nh ƒë√£ l√†m g√¨ h√¥m nay?..." rows="4" class="w-full bg-white/5 border border-white/10 rounded-2xl p-4 outline-none text-white resize-none text-left"></textarea>
        <div class="flex gap-4">
            <button onclick="addMemory()" class="flex-1 py-4 rounded-2xl font-bold text-black bg-white hover:bg-sky-400 transition-colors uppercase tracking-widest text-sm">L∆∞u l·∫°i</button>
            <button onclick="document.getElementById('timeline-modal').classList.add('hidden')" class="px-8 py-4 rounded-2xl font-bold text-white bg-white/10 hover:bg-white/20 transition-colors">H·ªßy</button>
        </div>
      </div>
    </div>
  </div>

  <audio id="main-audio" preload="auto"></audio>

  <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.158.0/build/three.module.js" } } </script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, where, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import * as THREE from 'three';

    const firebaseConfig = { apiKey: "AIzaSyCtXpEIp65Uyr8YbJUPqPz8x6CzqC8Q4Xg", authDomain: "todo-list-8d4c3.firebaseapp.com", projectId: "todo-list-8d4c3", storageBucket: "todo-list-8d4c3.firebasestorage.app", messagingSenderId: "926023141272", appId: "1:926023141272:web:7c1fe53d54364143098ded" };
    const app = initializeApp(firebaseConfig); const db = getFirestore(app);
    let userData = null; let selectedUserId = null;

    // --- NH·∫†C LOGIC ---
    let songs = [];
    let currentSongIndex = 0;
    const audio = document.getElementById('main-audio');
    const playBtn = document.getElementById('play-btn');
    const disk = document.getElementById('music-disk');
    const playerEl = document.getElementById('floating-player');
    const waveEl = document.getElementById('mini-wave');

    // C·∫≠p nh·∫≠t tr·∫°ng th√°i giao di·ªán (ƒëƒ©a xoay, icon, s√≥ng nh·∫°c)
    function updateUIState(isPlaying) {
        if (isPlaying) {
            playBtn.innerText = '‚è∏'; 
            disk.classList.remove('music-paused');
            disk.classList.add('playing-glow');
            waveEl.classList.remove('hidden');
        } else {
            playBtn.innerText = '‚ñ∂'; 
            disk.classList.add('music-paused'); 
            disk.classList.remove('playing-glow');
            waveEl.classList.add('hidden');
        }
        renderSongList();
    }

    // H√†m ph√°t b√†i h√°t theo Index
    window.loadAndPlay = (index) => {
        if (!songs[index]) return;
        
        // N·∫øu nh·∫•n ƒë√∫ng b√†i ƒëang ph√°t th√¨ Pause/Resume
        if (currentSongIndex === index && audio.src === songs[index].url) {
            if (audio.paused) {
                audio.play();
                updateUIState(true);
            } else {
                audio.pause();
                updateUIState(false);
            }
            return;
        }

        // Ph√°t b√†i m·ªõi
        currentSongIndex = index;
        audio.src = songs[index].url;
        document.getElementById('current-song-title').innerText = songs[index].name;
        document.getElementById('current-song-author').innerText = songs[index].author ? `G·ª≠i b·ªüi: ${songs[index].author}` : "G·ª≠i b·ªüi: ·∫®n danh";
        
        // Hi·ªáu ·ª©ng nh·∫π khi ƒë·ªïi b√†i
        disk.style.transform = "scale(1.1)";
        setTimeout(() => disk.style.transform = "scale(1)", 300);

        audio.play().then(() => updateUIState(true)).catch(e => console.error("L·ªói ph√°t nh·∫°c:", e));
    };

    // Ch·ª©c nƒÉng n√∫t Next
    window.nextSong = () => {
        if (songs.length === 0) return;
        let nextIdx = (currentSongIndex + 1) % songs.length;
        loadAndPlay(nextIdx);
    };

    // Ch·ª©c nƒÉng n√∫t Prev
    window.prevSong = () => {
        if (songs.length === 0) return;
        let prevIdx = (currentSongIndex - 1 + songs.length) % songs.length;
        loadAndPlay(prevIdx);
    };

    window.toggleMusic = () => {
        if (audio.paused) { audio.play(); updateUIState(true); }
        else { audio.pause(); updateUIState(false); }
    };

    window.uploadSong = async () => {
        const name = document.getElementById('song-name').value;
        const url = document.getElementById('song-url').value;
        if (!name || !url) return alert("Nh·∫≠p ƒë·ªß th√¥ng tin nh·∫°c nh√©!");
        await addDoc(collection(db, "songs"), { 
            name, url, author: userData.name, createdAt: serverTimestamp() 
        });
        document.getElementById('song-name').value = ''; document.getElementById('song-url').value = '';
    };

    window.deleteSong = async (id, event) => { 
        event.stopPropagation();
        if (confirm("X√≥a b√†i n√†y?")) await deleteDoc(doc(db, "songs", id)); 
    };

    function renderSongList() {
        const listContainer = document.getElementById('song-list');
        if(!listContainer) return;
        listContainer.innerHTML = songs.map((s, i) => {
            const isCurrentPlaying = (currentSongIndex === i && !audio.paused);
            return `
                <div onclick="loadAndPlay(${i})" class="bento-card p-5 rounded-2xl flex justify-between items-center border border-white/5 hover:border-sky-500/50 transition-all group cursor-pointer ${isCurrentPlaying ? 'border-sky-500/50 bg-sky-500/5' : ''}">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center relative overflow-hidden">
                            <img src="https://cdn-icons-png.flaticon.com/512/6048/6048452.png" class="w-full h-full object-cover opacity-20 absolute disk-rotate ${isCurrentPlaying ? '' : 'music-paused'}">
                            <span class="relative z-10 text-xs">${isCurrentPlaying ? '‚è∏' : '‚ñ∂'}</span>
                        </div>
                        <div>
                           <p class="text-white font-bold text-sm ${isCurrentPlaying ? 'text-sky-400' : ''}">${s.name}</p>
                           <p class="text-[9px] text-slate-500 uppercase">Ng∆∞·ªùi g·ª≠i: ${s.author || '·∫®n danh'}</p>
                        </div>
                    </div>
                    <button onclick="deleteSong('${s.id}', event)" class="text-red-500/50 text-xs hover:text-red-500 p-2">X√≥a</button>
                </div>`;
        }).join('');
    }

    function initMusicSystem() {
        onSnapshot(query(collection(db, "songs"), orderBy("createdAt", "desc")), (snap) => {
            songs = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderSongList();
            if (songs.length > 0) {
                playerEl.classList.add('show');
                if(!audio.src) {
                    audio.src = songs[0].url;
                    document.getElementById('current-song-title').innerText = songs[0].name;
                    document.getElementById('current-song-author').innerText = songs[0].author ? `G·ª≠i b·ªüi: ${songs[0].author}` : "G·ª≠i b·ªüi: ·∫®n danh";
                }
            }
        });
        audio.onended = () => nextSong();
    }

    // --- C√ÅC H√ÄM C∆† B·∫¢N GI·ªÆ NGUY√äN ---
    window.toggleSidebar = () => document.getElementById('sidebar').classList.toggle('open');
    window.togglePassword = (id) => { const el = document.getElementById(id); el.type = el.type === 'password' ? 'text' : 'password'; };
    window.selectUser = (id) => { selectedUserId = id; document.getElementById('profile-select').classList.add('hidden'); document.getElementById('password-box').classList.remove('hidden'); };
    
    document.getElementById('btn-login-verify').onclick = async () => {
      const pass = document.getElementById('login-password').value;
      const userDoc = await getDoc(doc(db, "users", selectedUserId));
      if (userDoc.exists() && userDoc.data().password === pass) {
        userData = { id: selectedUserId, name: userDoc.data().name || (selectedUserId === 'bao' ? 'B·∫£o' : 'Ng·ªçc Anh') };
        sessionStorage.setItem('memory_session', JSON.stringify(userData));
        enterStudio();
      } else { alert("Sai m·∫≠t kh·∫©u r·ªìi! ‚ú®"); }
    };

    window.addMemory = async () => {
        const title = document.getElementById('m-title').value;
        const desc = document.getElementById('m-desc').value;
        if(!title || !desc) return alert("H√£y nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin n√®!");
        await addDoc(collection(db, "memories"), { title, desc, author: userData.id, date: new Date().toISOString() });
        document.getElementById('m-title').value = ''; document.getElementById('m-desc').value = '';
        document.getElementById('timeline-modal').classList.add('hidden');
    };

    function enterStudio() {
      document.getElementById('login-overlay').style.display = 'none';
      const isBao = userData.id === 'bao';
      document.getElementById('user-greeting').innerText = `Ch√†o ${userData.name} ‚ú®`;
      document.getElementById('user-avatar').innerHTML = `<img src="${isBao ? './images/haruto.png' : './images/NgocAnh.png'}" class="w-full h-full object-cover">`;
      initMusicSystem(); initTimer(); initThreeJS(); loadMemories(); 
      setTimeout(() => document.querySelectorAll('.active .reveal-text').forEach((el, i) => setTimeout(() => el.classList.add('reveal-active'), i * 150)), 100);
    }

    function initTimer() {
      const start = new Date('2025-12-15T00:00:00');
      const daysMain = document.getElementById('days-main');
      function update() {
        const diff = new Date() - start; const targetDays = Math.max(0, Math.floor(diff/86400000));
        daysMain.innerText = targetDays;
        document.getElementById('hrs').innerText = String(Math.floor((diff%86400000)/3600000)).padStart(2, '0');
        document.getElementById('mins').innerText = String(Math.floor((diff%3600000)/60000)).padStart(2, '0');
        document.getElementById('secs').innerText = String(Math.floor((diff%60000)/1000)).padStart(2, '0');
      }
      update(); setInterval(update, 1000);
    }

    function initThreeJS() {
      const scene = new THREE.Scene(); 
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('threejs-canvas'), antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      const starGeo = new THREE.BufferGeometry(); const starPoints = new Float32Array(2000 * 3);
      for(let i=0; i<6000; i++) starPoints[i] = (Math.random()-0.5)*100;
      starGeo.setAttribute('position', new THREE.BufferAttribute(starPoints, 3));
      const starMesh = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 0.1, transparent: true, opacity: 0.3}));
      scene.add(starMesh); camera.position.z = 5;
      function animate() { requestAnimationFrame(animate); starMesh.rotation.y += 0.0003; renderer.render(scene, camera); }
      animate();
      window.addEventListener('resize', () => { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); });
    }

  window.loadMemories = (selectedDate = null) => {
    let memoriesRef = collection(db, "memories");
    let q = query(memoriesRef, orderBy("date", "desc"));

    // Logic l·ªçc ng√†y n·∫øu c√≥ ch·ªçn
    if (selectedDate) {
        const start = new Date(selectedDate).toISOString();
        const end = new Date(new Date(selectedDate).setHours(23,59,59,999)).toISOString();
        q = query(memoriesRef, where("date", ">=", start), where("date", "<=", end), orderBy("date", "desc"));
    }

    onSnapshot(q, (snap) => {
        const contentEl = document.getElementById('timeline-content');
        if (snap.empty) {
            contentEl.innerHTML = `<p class="text-center opacity-30 py-20 text-white">Ch∆∞a c√≥ k·ª∑ ni·ªám n√†o ƒë∆∞·ª£c ghi l·∫°i...</p>`;
            return;
        }

        contentEl.innerHTML = snap.docs.map(doc => {
            const d = doc.data();
            const isBao = d.author === 'bao';
            const color = isBao ? '#0ea5e9' : '#f472b6';
            
            // Th√™m class reveal-active tr·ª±c ti·∫øp n·∫øu kh√¥ng mu·ªën ch·ªù animation b·ªã l·ªói
            return `<div class="memory-row flex w-full relative min-h-[150px] ${isBao ? 'md:flex-row' : 'md:flex-row-reverse'}">
                <div class="timeline-dot" style="background: ${color}; box-shadow: 0 0 15px ${color}"></div>
                <div class="memory-card-wrapper w-full md:w-1/2 ${isBao ? 'md:pr-14' : 'md:pl-14'}">
                    <div class="reveal-text reveal-active bento-card p-6 md:p-10 rounded-[2rem] md:rounded-[2.5rem] inline-block w-full border-t-4 shadow-2xl" style="border-top-color: ${color}">
                        <p class="text-[10px] md:text-[11px] font-black uppercase mb-3 tracking-[0.2em]" style="color: ${color}">${isBao ? 'B·∫£o' : 'Ng·ªçc Anh'} ‚Ä¢ ${new Date(d.date).toLocaleDateString('vi-VN')}</p>
                        <h4 class="text-2xl md:text-3xl font-black text-white italic text-left mb-3">${d.title}</h4>
                        <p class="text-slate-400 text-sm md:text-lg italic text-left leading-relaxed">"${d.desc}"</p>
                    </div>
                </div>
                <div class="hidden md:block md:w-1/2"></div>
            </div>`;
        }).join('');
    });
}

    window.switchPage = (pageId, btn) => {
      if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('open');
      document.querySelectorAll('.page').forEach(p => { p.classList.add('hidden'); p.classList.remove('active'); });
      document.getElementById(pageId).classList.remove('hidden'); document.getElementById(pageId).classList.add('active');
      document.querySelectorAll('.nav-link').forEach(l => { l.classList.add('opacity-50'); l.classList.remove('active'); });
      btn.classList.add('active'); btn.classList.remove('opacity-50');
      if (pageId === 'music-lab') renderSongList();
    };

    const session = sessionStorage.getItem('memory_session');
    if (session) { userData = JSON.parse(session); enterStudio(); }
  </script>
</body>
</html>